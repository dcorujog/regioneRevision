---
title: "HepG2 ENCODE analysis"
author: "David Corujo"
date: "2023-09-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load packages

```{r}
library(rtracklayer)
library(GenomicRanges)
library(regioneReloaded)
```


# Load data for selected facors

## Load metadata

```{r}
metadata <- read.delim("./encode_metadata.tsv", skip = 1)
nrow(metadata)
```

## Load bed files and annotate with target name

```{r}
files <- list.files("./ENCODE", full.names = F)
anno <- data.frame(fileName = files,
                   fileID = gsub(".bed.gz", "", files))
anno$target <- unlist(lapply(anno$fileID, FUN = function(x) metadata$Target.of.assay[grep(x, metadata$Files)]))

extraCols_narrowPeak <- c(singnalValue = "numeric", pValue = "numeric",
                          qValue = "numeric", peak = "integer")
rsList <- lapply(anno$fileName, FUN = function(x) rtracklayer::import(paste0("./ENCODE/", x), extraCols = extraCols_narrowPeak))
names(rsList) <- anno$target 
rsList
```

# Export region sets as RDS

```{r}
saveRDS(rsList, file = "regionSets/ENCODE_sets.RDS")
```

# Load region sets as RDS

```{r}
load("regionSets/ENCODE_sets.RDS")
```

# Test permTest

```{r}
permRes <- crosswisePermTest(Alist = rsList,
                              genome = "hg38",
                              evFUN = "numOverlaps",
                              ranFUN = "resampleGenome",
                              count.once = TRUE,
                              ntimes = 10,
                              mc.cores = 20)
```

# Check results from local run

```{r}
permRes <- makeCrosswiseMatrix(permRes)
plotCrosswiseMatrix(permRes)
```

# Check results from HPC run

```{r}
load("hpcResults/permResENCODE_circularData")
permResTF <- makeCrosswiseMatrix(permResHIST, zs.type = "z_score", pvcut = 0.01, subEX = 0, symm_matrix = F)
plotCrosswiseMatrix(permResTF, matrix_type = "association")
```


```{r}
permResPOLR2A <- makeCrosswiseMatrix(permResPOLR2A, symm_matrix = F, clusterize = F, zs.type = "z_score")
plotCrosswiseMatrix(permResPOLR2A, matrix_type = "association")
```