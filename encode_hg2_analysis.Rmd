---
title: "HepG2 ENCODE analysis"
author: "David Corujo"
date: "2023-09-05"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Load packages

```{r}
library(rtracklayer)
library(GenomicRanges)
library(regioneReloaded)
```


# Load data for selected facors

## Load metadata

```{r}
metadata <- read.delim("./encode_metadata.tsv", skip = 1)
head(metadata)
```

## Load bed files and annotate with target name

```{r}
files <- list.files("./ENCODE", full.names = F)
anno <- data.frame(fileName = files,
                   fileID = gsub(".bigBed", "", files))
anno$target <- unlist(lapply(anno$fileID, FUN = function(x) metadata$Target.of.assay[grep(x, metadata$Files)]))

rsList <- lapply(anno$fileName, FUN = function(x) rtracklayer::import(paste0("./ENCODE/", x)))
names(rsList) <- anno$target 
```

# Split the analysis in two sets to showcase different aspecs

Set1 - MAF, FOXA and CTCF/Cohesin -> show the association between known protein complexes
Set2 - POLR2A, POLR2ApS2, H3K27Ac, H3K4me3, H3K36me3

```{r}
allENCODE <- rsList
POLR2A <- rsList[grep("POLR2A", names(rsList))] 
HIST <- rsList[grep("H3K", names(rsList))] 
TF <- rsList[!grepl("POLR2A|H3K", names(rsList))]
```

# Export region sets as RData

```{r}
save(allENCODE, POLR2A, HIST, TF, file = "regionSets/ENCODE_sets.RData")
```

# Load region sets as RData

```{r}
load("regionSets/ENCODE_sets.RData")
```

# Test permTest

```{r}
permRes <- crosswisePermTest(Alist = rsList,
                              genome = "hg38",
                              evFUN = "numOverlaps",
                              ranFUN = "resampleGenome",
                              count.once = TRUE,
                              ntimes = 10,
                              mc.cores = 20)
```

# Check results from local run

```{r}
permRes <- makeCrosswiseMatrix(permRes)
plotCrosswiseMatrix(permRes)
```

# Check results from HPC run

```{r}
load("hpcResults/permResENCODE.RData")
permResTF <- makeCrosswiseMatrix(permResTF, zs.type = "z_score", pvcut = 0.01, subEX = 0, hc.method = "complete")
plotCrosswiseMatrix(permResTF, matrix_type = "association")
```


```{r}
permResPOLR2A <- makeCrosswiseMatrix(permResPOLR2A, symm_matrix = F, clusterize = F, zs.type = "z_score")
plotCrosswiseMatrix(permResPOLR2A, matrix_type = "association")
```